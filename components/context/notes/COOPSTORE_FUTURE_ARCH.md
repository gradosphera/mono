# Техническое задание: Архитектура маркетплейса приложений для распределенных бэкендов

## Контекст проблемы

Мы имеем распределенную систему из множества бэкендов, каждый из которых обладает собственным локальным магазином приложений. Требуется централизовать управление приложениями через единый маркетплейс, обеспечив контроль доступа и монетизацию.

## Основные требования

1. **Централизованный каталог** приложений с возможностью монетизации
2. **Установка приложений на уровне бэкенда** (не пользователя)
3. **Контроль доступа** к платным приложениям
4. **Минимальная нагрузка** на систему валидации
5. **Безопасность** без единой точки отказа

## Предлагаемая архитектура

### 1. Компоненты системы

```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   Маркетплейс   │────│   Распределенные  │────│   Приложения    │
│   (Central API) │    │     Бэкенды      │    │  (Developers)   │
└─────────────────┘    └──────────────────┘    └─────────────────┘
```

### 2. Модель токенов

**Backend Admin Token**
- Долгоживущий (365 дней)
- Права: установка/удаление приложений, управление лицензиями
- Используется только в server-to-server коммуникации

**Backend User Token**
- Краткосрочный (1 час)
- Права: чтение списка установленных приложений
- Используется для загрузки каталога пользователями

**User App Access Token**
- Краткосрочный (30 минут)
- Содержит: backend_id, user_id, app_id, permissions
- Передается в IFrame приложений для валидации доступа

### 3. Workflow установки приложений

**Для администраторов бэкенда:**
1. Админ запрашивает полный каталог через Backend Admin Token
2. Маркетплейс возвращает все приложения со статусами лицензий
3. Админ выбирает приложение для установки
4. Система проверяет наличие активной лицензии
5. При успехе - создается запись об установке
6. Бэкенд скачивает файлы приложения с серверов разработчика

**Для обычных пользователей:**
1. Пользователь заходит на сайт бэкенда
2. Система запрашивает список установленных приложений через Backend User Token
3. Маркетплейс возвращает только доступные для данного бэкенда приложения
4. Пользователь выбирает приложение
5. Бэкенд генерирует User App Access Token
6. Приложение загружается в IFrame с переданным токеном

### 4. Механизм контроля доступа

**Трехуровневая валидация:**

1. **Предварительная проверка** - маркетплейс фильтрует доступные приложения
2. **Валидация при загрузке** - приложение проверяет JWT токен локально
3. **Периодическая ревалидация** - приложение проверяет токен каждые 5 минут

**Техническая реализация валидации:**
- Приложения кэшируют публичные ключи бэкендов (24 часа)
- Валидация JWT происходит статически без запросов к API
- Короткое время жизни токенов (30 мин) минимизирует риски

### 5. Монетизация и лицензии

**Модель лицензирования:**
- Лицензия выдается на уровень бэкенда
- Поддержка различных моделей оплаты (месячная, годовая, perpetual)
- Trial-периоды для тестирования
- Автоматическое отключение при неоплате

**Схема данных лицензий:**
```sql
backend_licenses (backend_id, app_id, status, expires_at, payment_plan)
installations (backend_id, app_id, installed_at, config)
```

### 6. Безопасность и производительность

**Меры безопасности:**
- Разделение прав через разные типы токенов
- Короткое время жизни пользовательских токенов
- Статическая валидация без зависимостей от API маркетплейса
- Кэширование криптографических ключей

**Оптимизация производительности:**
- Локальная проверка JWT подписей (~1-5ms)
- Кэширование публичных ключей (24 часа)
- Минимальные запросы к центральному API
- Предварительная фильтрация на стороне маркетплейса

## Критические вопросы для дальнейшего исследования

1. **Механизм отзыва доступа** - как оперативно блокировать приложения при неоплате?
2. **Кэширование и инвалидация** - стратегии обновления публичных ключей
3. **Мониторинг и аналитика** - отслеживание использования платных функций
4. **Grace period** -如何处理 situations when payment is delayed?
5. **Миграция с текущей системы** - план перехода с локальных магазинов

## Expected Outcomes

- Единая точка управления приложениями
- Контроль доступа к платному контенту
- Масштабируемая архитектура
- Минимальное влияние на производительность
- Гибкая система монетизации

Требуется проработка каждого компонента с учетом конкретных технических ограничений и бизнес-требований.
