# Архитектура системы расширений

## Обзор

Система расширений построена на принципах модульной архитектуры и позволяет динамически добавлять новые возможности в приложение без изменения основного кода. Расширения могут быть как полноценными рабочими столами (desktops), так и дополнительными функциями (extensions).

## Основные компоненты

### 1. Backend (Controller)

#### Реестр расширений
- **Файл**: `controller/src/extensions/extensions.registry.ts`
- **Назначение**: Централизованный реестр всех доступных расширений
- **Структура**: Объект с конфигурациями расширений (название, описание, классы, схемы)

#### Модуль расширений
- **Файл**: `controller/src/extensions/extensions.module.ts`
- **Назначение**: Регистрация всех расширений в NestJS DI контейнере
- **Принцип**: Динамический модуль с автоматическим импортом всех классов расширений

### 2. Frontend (Desktop)

#### Магазин расширений
- **Компоненты**: ExtensionsShowcase, ExtensionPage
- **Функции**: Просмотр, установка, настройка и управление расширениями
- **API**: GraphQL мутации для установки/отключения расширений

#### Рабочие столы (Workspaces)
- **Store**: DesktopStore (Pinia)
- **Функции**: Управление списком рабочих столов, маршрутами, активным состоянием
- **Принцип**: Каждый workspace соответствует установленному расширению

#### Меню системы
- **Первый уровень**: WorkspaceMenu - кнопки рабочих столов
- **Второй уровень**: SecondLevelMenuList - навигация внутри рабочего стола
- **Фильтрация**: По ролям пользователя и условиям

## Принципы работы

### Инициализация
1. **Загрузка системной информации** - базовые настройки кооператива
2. **Инициализация Desktop Store** - получение списка доступных рабочих столов
3. **Регистрация маршрутов** - базовые маршруты рабочих столов в Vue Router
4. **Загрузка всех расширений** - автоматическая загрузка всех install.ts модулей
5. **Выбор активного workspace** - по ролям пользователя или сохраненным настройкам

### Установка расширения
1. **GraphQL мутация** - установка расширения на backend
2. **Обновление списка расширений** - перезагрузка данных из API
3. **Загрузка desktop** - получение обновленного списка рабочих столов
4. **Динамическая загрузка маршрутов** - загрузка routes из install.ts модуля
5. **Регистрация в router** - добавление маршрутов в Vue Router

### Структура расширения
```
extensions/{extension-name}/
├── install.ts          # Конфигурация workspace и маршрутов
├── entities/           # Бизнес-логика (Domain)
├── features/           # Действия пользователя (Use Cases)
├── pages/              # Страницы (UI)
├── shared/             # Общие компоненты
└── widgets/            # Виджеты (UI)
```

## Архитектурные принципы

### Feature-Sliced Design (FSD)
- **Entities**: Бизнес-сущности и их логика
- **Features**: Действия пользователя и сценарии использования
- **Pages**: Страницы приложения
- **Shared**: Переиспользуемые компоненты
- **Widgets**: Составные UI компоненты

### Принципы SOLID
- **Single Responsibility**: Каждый модуль отвечает за одну задачу
- **Open/Closed**: Расширения открыты для расширения, закрыты для модификации
- **Liskov Substitution**: Интерфейсы позволяют замену реализаций
- **Interface Segregation**: Минимальные интерфейсы для каждого модуля
- **Dependency Inversion**: Зависимости от абстракций, не от реализаций

### Domain-Driven Design (DDD)
- **Bounded Contexts**: Каждое расширение - изолированный контекст
- **Entities**: Доменные объекты с бизнес-логикой
- **Value Objects**: Неизменяемые объекты-значения
- **Services**: Бизнес-сервисы для сложной логики

## Типы расширений

### Desktop расширения
- Полноценные рабочие столы с собственным меню
- Примеры: soviet, chairman, participant, capital
- Имеют собственные маршруты и навигацию

### Functional расширения
- Дополнительные функции без собственного UI
- Примеры: powerup, yookassa, qrpay
- Расширяют возможности существующих рабочих столов

## Ролевая модель

### Роли пользователей
- **chairman**: Председатель совета
- **member**: Член совета
- **user**: Обычный пользователь

### Фильтрация доступа
- Маршруты фильтруются по ролям в meta.roles
- Условная логика через meta.conditions
- Динамическое скрытие недоступных элементов

## Состояние и хранение

### Pinia Stores
- **ExtensionStore**: Управление списком расширений
- **DesktopStore**: Управление рабочими столами и маршрутами

### Локальное хранилище
- **localStorage**: Сохранение выбранного рабочего стола
- **Session**: Управление аутентификацией пользователя

## Маршрутизация

### Vue Router
- **Base route**: Корневой маршрут приложения
- **Workspace routes**: Маршруты рабочих столов
- **Extension routes**: Вложенные маршруты расширений

### Динамическая регистрация
- Автоматическая загрузка маршрутов при инициализации
- Горячая регистрация маршрутов при установке расширений
- Проверка дубликатов для предотвращения конфликтов

## Производительность

### Ленивая загрузка
- **Dynamic imports**: Загрузка компонентов по требованию
- **markRaw()**: Предотвращение реактивности для компонентов Vue
- **Code splitting**: Разделение кода по расширениям

### Кэширование
- **Route caching**: Сохранение маршрутов в DesktopStore
- **Module caching**: Кэширование загруженных модулей
- **State persistence**: Сохранение состояния между сессиями

## Безопасность

### Аутентификация
- Проверка прав доступа к маршрутам
- Фильтрация по ролям пользователя
- Защита от несанкционированного доступа

### Валидация
- **Zod schemas**: Строгая типизация конфигураций
- **Input validation**: Проверка данных на frontend и backend
- **Error boundaries**: Обработка ошибок в расширениях

## Разработка и поддержка

### Добавление нового расширения
1. Создать папку в `extensions/`
2. Реализовать `install.ts` с конфигурацией
3. Добавить в `extensions.registry.ts`
4. Зарегистрировать модуль в `extensions.module.ts`
5. Протестировать установку и работу

### Тестирование
- **Unit tests**: Тестирование отдельных модулей
- **Integration tests**: Тестирование взаимодействия компонентов
- **E2E tests**: Полное тестирование сценариев использования

### Мониторинг
- **Логирование**: Отслеживание загрузки расширений
- **Метрики**: Мониторинг производительности
- **Обработка ошибок**: Graceful degradation при сбоях

## Заключение

Архитектура системы расширений обеспечивает гибкость, масштабируемость и поддерживаемость приложения. Модульный подход позволяет независимо развивать отдельные расширения, а строгие архитектурные принципы гарантируют качество и надежность кода.
