---
description: О правилах на бэкенде
globs: **/controller/**/*.ts
---
 # NestJS Controller и Чистая архитектура

## Основные принципы
1. Чистая архитектура - главный архитектурный подход. Пиши код с комментариями.
2. Типы IName, IChecksum256, ITimePointSec - это просто строки.
3. Домен должен быть полностью изолирован от инфраструктурных деталей.
4. Направление зависимостей - внутрь (к ядру, домену).
5. Домен, инфраструктура и приложение связаны через App.module, НЕ НУЖНО импортировать их друг в друга, а достаточно просто импортировать домен на уровне приложения чтобы использовать все экспорты домена.

## Структура проекта
- `domain/` - доменный слой (бизнес-логика, независимая от инфраструктуры)
- `infrastructure/` - инфраструктурный слой (адаптеры к внешним системам)
- `modules/` - слой приложения (DTO, резолверы, сервисы)

## Слои и их взаимодействие
1. **Домен**:
   - Содержит чистые доменные интерфейсы и реализованные на них сущности
   - НЕ должен зависеть от `cooptypes` (инфраструктурный контракт)
   - Использует собственные доменные типы (например, Date вместо строковых timestamp)
   - Интерфейсы портов описывают взаимодействие с внешними системами

2. **Инфраструктура**:
   - Содержит адаптеры к внешним системам (блокчейн, БД и т.д.)
   - Осуществляет преобразование между доменными и инфраструктурными типами
   - Общая логика преобразования выносится в утилитарные классы (например, `DomainToBlockchainUtils`)

3. **Модули (приложение)**:
   - DTO имплементируют доменные интерфейсы напрямую
   - Резолвер вызывает сервис, который принимает DTO
   - Сервис передает объекты DTO в интерактор приложения (юз-кейс)

## Правила

Чистая фрактальная трехуровневая архитектура срезов домена (domain) и инфраструктуры (infrastructure), оркестрируемая приложением (application). Фрактал раскрывается в расширениях (extensions), каждое из которых также выстраивается по правилам чистой трехуровневой архитектуры срезов домена и инфраструктуры с окрестрацией на уровне своего приложения.

Общая архитектура связей:
- AppResolver -> AppService[DTO<->Domain] -> AppInteractor -> DomainService -> DomainPort <- InfraAdapter -> [при необходимости] AnyAppOrDomainService

Все сервисы внедряются через инъекцию (DI) с указанием символа реализации. Импорты разрешены только вглубь - к домену. Из домена переход разрешен только в инфраструктуру через порт и его адаптер.

Прямые импорты без DI запрещены. Импорты из соседних срезов того же архитектурного уровня запрещены. Направление зависимостей от приложения - к домену, от домена через порт в его инфраструктурный адаптер.

Взаимодействие расширений с основным приложением осуществляется только через порты домена основного приложения.

Глобальные модули запрещены. В редких случаях сложных циклических зависимостей на период рефакторинга разрешается обоснованно использовать forwardRef.

Уровень приложения оркестрирует вызовы доменов через порты в инфраструктуру. Домены не обращаются друг к друга. Срезы уровня приложений не обращаются друг к другу, а только вызывают порты домена.

```
