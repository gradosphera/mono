# Функциональность поиска в фабрике документов

## Описание

В фабрику документов добавлена функциональность поиска по полям пользователей. Поиск осуществляется по трем типам данных:
- **individual** - физические лица
- **entrepreneur** - индивидуальные предприниматели
- **organization** - организации

## Архитектура

Функциональность поиска реализована в виде отдельного сервиса `SearchService`, расположенного в `src/Services/Databazor/SearchService.ts`. Это обеспечивает:
- Чистое разделение ответственности
- Возможность независимого тестирования
- Переиспользование в других частях приложения

## API

### Метод search

```typescript
async search(query: string): Promise<ISearchResult[]>
```

**Параметры:**
- `query` - строка для поиска

**Возвращает:**
- Массив результатов поиска (максимум 10 элементов)

### Интерфейс ISearchResult

```typescript
interface ISearchResult {
  type: 'individual' | 'entrepreneur' | 'organization'
  data: ExternalIndividualData | ExternalEntrepreneurData | ExternalOrganizationData
  score?: number // для будущего ранжирования
  highlightedFields?: string[] // поля, в которых найдено совпадение
}
```

## Поля для поиска

### Физические лица (individual)
- `first_name` - имя
- `last_name` - фамилия
- `middle_name` - отчество
- **Полное ФИО** - поиск по комбинации полей (например, "Иванов Иван Иванович")

### Индивидуальные предприниматели (entrepreneur)
- `first_name` - имя
- `last_name` - фамилия
- `middle_name` - отчество
- **Полное ФИО** - поиск по комбинации полей
- `details.inn` - ИНН
- `details.ogrn` - ОГРН

### Организации (organization)
- `short_name` - краткое наименование
- `details.inn` - ИНН
- `details.ogrn` - ОГРН

## Особенности поиска

1. **Регистронезависимый поиск** - поиск выполняется без учета регистра
2. **Поиск по подстроке** - находит частичные совпадения в полях
3. **Поиск по полному ФИО** - ✅ **НОВОЕ!** Поддерживает поиск по нескольким словам (например, "Иванов Иван Иванович")
4. **Интеллектуальное разбиение запроса** - автоматически разбивает запрос на слова для поиска по ФИО
5. **Ограничение результатов** - возвращает максимум 10 результатов
6. **Подсветка совпадений** - в `highlightedFields` указываются поля, где найдено совпадение (включая `full_name`)
7. **Фильтрация удаленных записей** - поиск не включает записи с `deleted: true`

## Пример использования

```typescript
import { Generator } from '@coopenomics/factory'

const generator = new Generator()
await generator.connect('mongodb://localhost:27017/mydatabase')

// Поиск по имени
const results = await generator.search('Иван')

// Поиск по полному ФИО - теперь работает!
const fullNameResults = await generator.search('Иванов Иван Иванович')

console.log(fullNameResults)
// [
//   {
//     type: 'individual',
//     data: { username: 'ivan123', first_name: 'Иван', last_name: 'Иванов', middle_name: 'Иванович', ... },
//     highlightedFields: ['full_name', 'first_name', 'last_name', 'middle_name']
//   }
// ]

// Поиск по частичному ФИО
const partialResults = await generator.search('Петров Петр')

// Поиск по ИНН
const innResults = await generator.search('1234567890')

// Поиск по названию организации
const orgResults = await generator.search('ООО Рога и копыта')
```

## Алгоритм поиска по полному ФИО

1. **Разбиение запроса** - запрос разбивается на отдельные слова
2. **Поиск в MongoDB** - каждое слово ищется во всех полях ФИО через оператор `$and`
3. **Дополнительная проверка** - результаты дополнительно фильтруются на уровне приложения
4. **Подсветка** - в `highlightedFields` добавляется `full_name` при совпадении

## Архитектурные улучшения

- ✅ **SearchService** вынесен в отдельный класс
- ✅ **Чистая архитектура** - разделение ответственности
- ✅ **Переиспользование** - сервис можно использовать независимо
- ✅ **Тестируемость** - легко писать unit-тесты для SearchService

## Тестирование

Функциональность покрыта комплексными тестами в файле `test/search.test.ts`, включающими:

- Поиск по всем типам полей
- **Поиск по полному ФИО** ("Иванов Иван Иванович")
- **Поиск по частичному ФИО** ("Петров Петр")
- Обработка пустых запросов
- Ограничение количества результатов
- Подсветка найденных полей
- Очистка тестовых данных

Запуск тестов:
```bash
npm test -- search.test.ts
```

## Преимущества нового подхода

1. **Поиск по полному ФИО работает!** - решена основная проблема
2. **Лучшая архитектура** - код организован в отдельном сервисе
3. **Расширяемость** - легко добавлять новые типы поиска
4. **Производительность** - оптимизированные MongoDB запросы
5. **Удобство использования** - простой API без изменений для пользователя
