# Логика работы с координаторами согласно ТЗ БЛАГОРОСТ v0.1

## Описание

Согласно ТЗ БЛАГОРОСТ v0.1, координатор - это пайщик, который привел инвестора. Координатор определяется автоматически по связи `referer` в таблице `accounts` контракта `registrator`. За приведение инвестора координатор получает 4% от **всех инвестиций** этого инвестора в **один результат**, но не более **100,000 RUB** за каждого инвестора и только до первой подачи презентации об этом инвесторе.

## Ключевые принципы новой логики

### 1. Накопление по результату
- Координатор может получать 4% с **всех инвестиций** одного инвестора в рамках одного результата
- Если инвестор вложил 10,000 RUB, а потом 1,000,000 RUB в один результат, координатор получит 4% с обеих сумм

### 2. Лимит 100,000 RUB на инвестора
- Максимальная сумма накоплений координатора за одного инвестора не может превышать 100,000 RUB
- Если 4% от инвестиций превышает лимит, сумма ограничивается

### 3. Одна презентация на инвестора
- Координатор может подать презентацию об инвесторе только один раз
- После подачи презентации накопления за этого инвестора в других результатах не происходят

## Изменения в структуре данных

### 1. Таблица invest
Добавлено поле `coordinator_username` для связи инвестиции с конкретным координатором, который привел инвестора (определяется автоматически).

### 2. Таблица coordinator
- Добавлено поле `pending_coordinator_base` для накопления 4% от приведенных инвестиций до момента сдачи результата
- Добавлено поле `total_accumulated_all_investors` для контроля общих накоплений

### 3. Таблица coordinator_payout (обновленная)
Таблица для отслеживания выплат координаторам за конкретных инвесторов с привязкой к результату:
- `result_hash` - хэш результата, в котором была подана презентация
- `total_accumulated` - общая накопленная сумма за инвестора
- `amount_claimed` - сумма, полученная при подаче презентации

## Процесс работы

### 1. Автоматическая регистрация координатора (createinvest)
- При создании инвестиции система проверяет поле `referer` в таблице `accounts` контракта `registrator`
- Если `referer` указан и является участником проекта (имеет договор УХД), он автоматически становится координатором
- Если координатор еще не зарегистрирован в проекте, он добавляется автоматически
- Инвестиция сохраняется с привязкой к координатору

### 2. Авторизация инвестиции (capauthinvst)
- При авторизации инвестиции советом проверяется:
  - Не подавал ли координатор уже презентацию за этого инвестора
  - Не превышен ли лимит накоплений 100,000 RUB за этого инвестора
- Если условия выполнены, начисляется 4% (с учетом лимита)
- Сумма добавляется в `pending_coordinator_base`

### 3. Получение средств координатором (claimcoordntr)
- Координатор подает заявление с презентацией о приведенных инвесторах для конкретного результата
- Система записывает выплаты за всех инвесторов в таблицу `coordinator_payout`
- Средства из `pending_coordinator_base` переносятся в `coordinator_base` и `earned`
- Координатор может получить выплату через `paycoordntr`

## Примеры сценариев

### Сценарий 1: Накопление в одном результате
```
Инвестор bob (приведен alice):
- Инвестиция 1: 10,000 RUB → alice получает право на 400 RUB (4%)
- Инвестиция 2: 1,000,000 RUB → alice получает право на 40,000 RUB (4%)
- Инвестиция 3: 2,000,000 RUB → alice получает право на 59,600 RUB (остаток до лимита 100,000)
- Итого: alice накопила 100,000 RUB за bob
```

### Сценарий 2: Превышение лимита
```
Инвестор charlie (приведен alice):
- Инвестиция: 3,000,000 RUB → alice получает право на 100,000 RUB (лимит)
- 4% от 3,000,000 = 120,000 RUB, но ограничено лимитом
```

### Сценарий 3: После подачи презентации
```
alice подает презентацию за bob в результате А
Позже bob инвестирует в результат Б → alice НЕ получает дополнительную выплату
```

## Константы

```cpp
static constexpr double COORDINATOR_PERCENT = 0.04; // 4%
static constexpr int64_t MAX_COORDINATOR_ACCUMULATION = 10000000; // 100,000 RUB
```

## Условия для становления координатором

1. **Referer в таблице accounts**: Инвестор должен быть зарегистрирован с указанием referer
2. **Участник проекта**: Referer должен иметь активный договор УХД по данному проекту
3. **Автоматическая регистрация**: Координатор регистрируется автоматически при первой инвестиции

## Ключевые принципы

1. **Автоматическое определение**: Координатор определяется по referer, ручное назначение отсутствует
2. **Накопление по результату**: Координатор получает 4% с всех инвестиций одного инвестора в рамках одного результата
3. **Лимит на инвестора**: Максимум 100,000 RUB за каждого приведенного инвестора
4. **Отложенное начисление**: Накопления происходят, но не начисляются до предоставления презентации
5. **Одна презентация на инвестора**: После подачи презентации повторные накопления за этого инвестора не происходят
6. **Защита от повторных выплат**: Система отслеживает выплаты и предотвращает дублирование

## Совместимость

Для существующих данных поле `coordinator_username` может быть пустым (name()), что означает отсутствие координатора для данной инвестиции.

## Удаленные действия

- `addcoordntr` - убрано, так как координаторы регистрируются автоматически 