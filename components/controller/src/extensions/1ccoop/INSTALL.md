# Установка расширения 1CCoop

## Описание

Расширение 1CCoop предоставляет GraphQL API для синхронизации документов кооператива с внешней бухгалтерией 1С.

## Требования

- Контроллер версии 1.0.0 или выше
- Настроенное подключение к блокчейну

## Установка

Расширение встроено в контроллер и активируется автоматически.

## Аутентификация

При первой инициализации расширение автоматически генерирует секретный ключ (`secret_key`), который сохраняется в конфигурации расширения. Этот ключ необходимо скопировать и настроить в системе 1С.

### Получение секретного ключа

Секретный ключ можно найти в настройках расширения в панели председателя (Магазин расширений → Интеграция 1С → Настройки).

### Использование секретного ключа

Для каждого запроса к API необходимо передавать секретный ключ в заголовке:

```
x-onecoop-secret-key: <ваш_секретный_ключ>
```

## Использование

### GraphQL Query

```graphql
query GetDocuments($data: GetOneCoopDocumentsInput!) {
  onecoopGetDocuments(data: $data) {
    items {
      action
      block_num
      package
      hash
      data
    }
    total_count
    total_pages
    current_page
    max_block_num
  }
}
```

### Переменные

```json
{
  "data": {
    "block_from": 0,
    "block_to": null,
    "page": 1,
    "limit": 100
  }
}
```

### Пример запроса с curl

```bash
curl -X POST \
  -H "Content-Type: application/json" \
  -H "x-onecoop-secret-key: ваш_секретный_ключ" \
  -d '{"query": "query { onecoopGetDocuments(data: { block_from: 0 }) { items { action block_num hash data } total_count max_block_num } }"}' \
  https://your-api-endpoint/graphql
```

## Поддерживаемые типы документов

- `joincoop` - Вступление в кооператив

## Формат ответа

Для каждого типа документа возвращаются специфичные данные:

### joincoop

```json
{
  "action": "joincoop",
  "block_num": 12345,
  "package": "ABC123...",
  "hash": "DEF456...",
  "data": {
    "username": "user123",
    "account_type": "individual",
    "full_name": "Иванов Иван Иванович",
    "initial_contribution": 1000.00,
    "minimum_contribution": 500.00,
    "created_at": "01.01.2024 12:00",
    "coopname": "voskhod"
  }
}
```

## Синхронизация

Для эффективной синхронизации рекомендуется использовать поле `max_block_num` из ответа для следующего запроса. Это гарантирует, что вы не пропустите ни одного документа и не получите дубликаты.

```
Первый запрос: block_from = 0
Ответ: max_block_num = 12345

Следующий запрос: block_from = 12346
Ответ: max_block_num = 12500
...
```

## Безопасность

- Секретный ключ генерируется криптографически стойким способом (32 байта случайных данных)
- Ключ не регенерируется при перезапуске расширения
- Для изменения ключа необходимо удалить текущий ключ из конфигурации и перезапустить контроллер
- Сравнение ключей выполняется timing-safe способом для защиты от timing attacks
