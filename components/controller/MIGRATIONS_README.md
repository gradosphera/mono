# Система миграций TypeORM

## Обзор

В проекте настроена система миграций TypeORM для управления схемой базы данных. Синхронизация отключена, все изменения в схему вносятся только через миграции.

## Структура

Проект имеет два независимых подключения к базе данных:

1. **Основное подключение** (`default`) - для общих сущностей
2. **Capital подключение** (`capital`) - для сущностей capital модуля

## Файлы миграций

### Основные миграции
- Расположение: `src/infrastructure/database/typeorm/migrations/`
- Миграция создания таблиц: `1735660000001-CreateMainTables.ts`

### Capital миграции
- Расположение: `src/extensions/capital/infrastructure/database/migrations/`
- Миграция создания таблиц: `1735660000000-CreateCapitalTables.ts`

## Доступные команды

### Основные миграции (default connection)

```bash
# Генерация миграции на основе изменений в сущностях
npm run migration:generate MigrationName

# Создание пустой миграции
npm run migration:create MigrationName

# Запуск всех невыполненных миграций
npm run migration:run

# Откат последней миграции
npm run migration:revert
```

### Capital миграции (capital connection)

```bash
# Генерация миграции для capital модуля
npm run migration:generate:capital MigrationName

# Создание пустой миграции для capital
npm run migration:create:capital MigrationName

# Запуск миграций capital
npm run migration:run:capital

# Откат миграции capital
npm run migration:revert:capital
```

## Конфигурация

Конфигурация миграций находится в файле `ormconfig.js` в корне проекта.

## Автоматический запуск

Миграции автоматически запускаются при старте приложения благодаря настройке `migrationsRun: true` в модулях.

## Создание новой миграции

1. Внесите изменения в сущности (добавьте поля, измените типы и т.д.)
2. Запустите команду генерации миграции
3. Проверьте сгенерированный файл миграции
4. Запустите миграцию для применения изменений

## Примеры использования

### Добавление нового поля в сущность

1. Добавьте поле в декораторы TypeORM сущности
2. Запустите: `npm run migration:generate AddNewFieldToEntity`
3. Проверьте миграцию и примените: `npm run migration:run`

### Создание новой таблицы

1. Создайте новую сущность с декораторами TypeORM
2. Запустите: `npm run migration:generate CreateNewTable`
3. Примените миграцию: `npm run migration:run`

## Важные замечания

- Никогда не редактируйте существующие миграции вручную
- Всегда создавайте новые миграции для изменений схемы
- Тестируйте миграции на копии базы данных перед применением в продакшене
- Используйте описательные имена для миграций

## Откат миграций

Для отката последней миграции используйте:
```bash
npm run migration:revert
# или для capital:
npm run migration:revert:capital
```

## Проверка статуса миграций

TypeORM автоматически отслеживает выполненные миграции в таблице `migrations` (для основного подключения) или в аналогичной таблице для capital подключения.
